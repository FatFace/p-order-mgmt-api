<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:sqs="http://www.mulesoft.org/schema/mule/sqs" xmlns:amqp="http://www.mulesoft.org/schema/mule/amqp"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/amqp http://www.mulesoft.org/schema/mule/amqp/current/mule-amqp.xsd
http://www.mulesoft.org/schema/mule/sqs http://www.mulesoft.org/schema/mule/sqs/current/mule-sqs.xsd">
	<flow name="order-extract-impl-flow" doc:id="23a2590d-f562-46da-a911-2cf2098e8abe" initialState="stopped">
		<!-- <http:listener doc:name="Test Listener" doc:id="f4a25c17-79af-4c1d-a5cc-381e793ea577" config-ref="x-template-api-httpListenerConfig" path="/test"/> -->
		<scheduler doc:name="Scheduler" doc:id="18363b90-3733-44b8-b930-913a1be28952" >
			<scheduling-strategy >
				<cron expression="${cron.expression.orderextract}" />
			</scheduling-strategy>
		</scheduler>
		<ee:transform doc:name="Flow Name" doc:id="02821f9f-729a-4648-b997-59abceff4329" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="flowName" ><![CDATA[%dw 2.0
output application/java
---
'order-extract-impl-flow']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		
		<ee:transform doc:name="Audit Key" doc:id="447e8b4c-6ed6-42a4-ac56-a27de356d0e2" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="primaryKey" ><![CDATA[%dw 2.0
output application/java
---
'orderId']]></ee:set-variable>
				<ee:set-variable variableName="secondaryKey" ><![CDATA[%dw 2.0
output application/java
---
'productId']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Log Receiver Entry" doc:id="77d62498-8cc7-4855-9310-c8fd5c7897f0" name="log-receiver-entry-sub-flow" />
		<flow-ref doc:name="Audit Receiver Entry" doc:id="bae2eaf2-a4d8-4332-b476-870c31df3ae1" name="audit-receiver-entry-sub-flow"/>
		<flow-ref doc:name="call-s-jda-and-process-to-d365-impl-flow" doc:id="cc7dd770-911a-4451-8cc8-59819183625b" name="call-s-jda-and-process-to-d365-impl-flow"/>
		<flow-ref doc:name="Log Dispatcher Exit" doc:id="986bce07-fd29-46df-a2b5-8f370e86bb0f" name="log-dispatcher-exit-sub-flow"/>
		<flow-ref doc:name="Audit Dispatcher Exit" doc:id="bec990dc-8b03-4813-955c-422c63eecb9f" name="audit-dispatcher-exit-sub-flow"/>
	</flow>
	<flow name="call-s-jda-and-process-to-d365-impl-flow" doc:id="586a59a6-47ab-44e1-b530-8afc050bbc93" >
		<ee:transform doc:name="Flow Name" doc:id="c245b3ff-0f13-4be7-aecc-589ea8c46bfa" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="flowName" ><![CDATA[%dw 2.0
output application/java
---
'call-s-jda-and-process-to-d365-impl-flow']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Log Process Entry" doc:id="7def573e-e35e-4f59-b8f5-61a7b3ec94c3" name="log-process-entry-sub-flow" />
		<http:request method="GET" doc:name="S-JDA-HTTP-Request-Configuration" doc:id="32ab8900-4bc9-4e3d-875c-22de403920c5" config-ref="JDA_HTTP_Request_configuration" path="${http.jda.orders.path}" responseTimeout="${response.timeout}">
		<http:query-params ><![CDATA[#[output application/java
---
{
	"client_id" : p('secure::http.jda.clientId'),
	"client_secret" : p('secure::http.jda.clientSecret')
}]]]></http:query-params>
		</http:request>
		<flow-ref doc:name="Log Process Exit" doc:id="4cdb440a-5b24-49c1-b372-f37092e1fe01" name="log-process-exit-sub-flow"/>
		
		<set-variable value="#[attributes.headers.has-more-files]" doc:name="Set Has More Files" doc:id="1fa39fcf-a8cf-4e9a-b0fa-687bd5c36751" variableName="hasMoreFiles"/>
		<choice doc:name="Choice" doc:id="1d575d75-492e-4e7c-b28d-dd96cbf8a864" >
			<when expression="#[payload != null and payload.orders != []]">
				<flow-ref doc:name="Flow Reference to Order Extract Check Manifest Data" doc:id="c1d2c83f-4e82-4c91-8100-9d093f42b861" name="order-extract-check-manifest-data-sub-flow"/>
			</when>
			<otherwise>
				<set-variable value="There are no order data to process" doc:name="Set Logging Payload" doc:id="d851938f-e129-41c0-b5ed-4ae9205905ab" variableName="loggingPayload" />
				<flow-ref doc:name="Logging Message" doc:id="12acbf38-f6ce-4203-ac75-b499b5b35fa4" name="logging-sub-flow"/>
			</otherwise>
		</choice>
		<choice doc:name="Choice" doc:id="0af6e8e1-cb61-4991-854f-f88169c6946a">
			<when expression="#[vars.hasMoreFiles == 'true']">
				<flow-ref doc:name="call-s-jda-and-process-to-d365-impl-flow" doc:id="9aee2451-507f-4599-ba8f-86835f0b407e" name="get-manifest-shipment-data-from-jda-and-process-to-d365-sub-flow" />
			</when>
			<otherwise>
				<set-variable value="There are no more manifest extract files to process" doc:name="Set Logging Payload" doc:id="cca705f5-3f2e-4eda-8876-505b9cb4fc35" variableName="loggingPayload" />
				<flow-ref doc:name="Logging Message" doc:id="2f4ea948-7ce7-483e-ac6b-dd9e72a7252c" name="logging-sub-flow"/>
			</otherwise>
		</choice>
	</flow>
	<sub-flow name="order-extract-check-manifest-data-sub-flow" doc:id="e36f7652-4cb0-405b-afd5-1d5835291f83" >
		<ee:transform doc:name="Flow Name" doc:id="2fb85c39-71f1-4fdc-a4dc-fc939f6162e9" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="flowName" ><![CDATA[%dw 2.0
output application/java
---
'order-extract-check-manifest-data-sub-flow']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Log Process Entry" doc:id="6878a8c4-14bb-4fc2-b1ab-539e6000a284" name="log-process-entry-sub-flow" />
		<ee:transform doc:name="Set Queue Variables" doc:id="f140519b-f4cc-4c4c-9e1c-fac0e1cdae2b">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="targetQueueVar"><![CDATA[%dw 2.0
output application/java
---
p('sqs.queue.target.order')]]></ee:set-variable>
				<ee:set-variable variableName="targetQueueUrl"><![CDATA[%dw 2.0
output application/java
---
p('sqs.queue.url.orderQueueUrl')]]></ee:set-variable>
				<ee:set-variable variableName="sendToQueue" ><![CDATA[%dw 2.0
output application/java
---
p('send.manifest.queue')]]></ee:set-variable>
			</ee:variables>
			
		</ee:transform>
		<ee:transform doc:name="Filtering" doc:id="3a23d39e-deaf-4e03-ab52-a34254baa3a7" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	orders: payload.orders filter ($."order-no" != null and $.status == 'shipped') map $
}]]></ee:set-payload>
			</ee:message>
			<ee:variables >
			</ee:variables>
		</ee:transform>
		<choice doc:name="Choice" doc:id="c72d933e-7050-4325-8357-b152854dfac2">
			<when expression="#[payload.orders != []]">
				<flow-ref doc:name="Flow Reference Get Manifest Data" doc:id="428e84de-f365-4349-9386-e92167cbf7b8" name="order-extract-get-manifest-data"/>
				
			</when>
			
			<otherwise>
				<set-variable value="The record is not an ecom order" doc:name="Set Logging payload" doc:id="aace8a5b-63c6-4cb2-ade2-0323bb3f144b" variableName="loggingPayload" />
				<flow-ref doc:name="Logging Message" doc:id="95a6a3de-d35f-4e7e-943f-01591f2f99e7" name="logging-sub-flow" />
			</otherwise>
			
		</choice>
		<flow-ref doc:name="Log Process Exit" doc:id="c998d439-0d54-4905-bad3-273c74dbd509" name="log-process-exit-sub-flow" />
	</sub-flow>
	<sub-flow name="order-extract-get-manifest-data" doc:id="fb474105-bef1-40e7-834f-e728f8fb1d7a" >
		<ee:transform doc:name="Flow Name" doc:id="840b0cee-d408-4dc1-8ac5-d6db5b0b99ce" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="flowName" ><![CDATA[%dw 2.0
output application/java
---
'order-extract-get-manifest-data']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Log Process Entry" doc:id="74097f4e-cd07-44e1-8bdb-3a6695a79691" name="log-process-entry-sub-flow" />
		<sqs:read doc:name="Read" doc:id="9fe81df9-a3bb-435a-b921-f391fffa8dd5" config-ref="Amazon_SQS_Configuration" queueUrl="#[vars.targetQueueUrl]" maxNumberOfMessages="8" target="manifestData">
			<reconnect frequency="${retry.frequency}" count="${retry.attempts}"/>
		</sqs:read>
		<choice doc:name="Choice" doc:id="e84144a6-44ff-4e08-8268-7ba143b34c0d" >
			<when expression="#[payload != null]">
				<ee:transform doc:name="Transform Message" doc:id="a97d5f0c-3a47-45ae-9428-b2152ff8adca" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise >
				<set-variable value="The record is not an ecom order" doc:name="Set Logging payload" doc:id="73320de0-0bc3-4493-8fe6-27cb1e9777fb" variableName="loggingPayload" />
				<flow-ref doc:name="Logging Message" doc:id="648243e9-2db8-4a80-9518-de124bcc936c" name="logging-sub-flow" />
			</otherwise>
		</choice>
		<ee:transform doc:name="Transform order extract To D365" doc:id="4475089e-4483-4d0f-998d-02f9a670bb78">
			<ee:message>
						<ee:set-payload resource="dwl/order-extract-jda-to-d365-mapping.dwl" />
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference send to d365" doc:id="9691c83f-6d2f-480d-b302-4adb884962ed" name="order-extract-send-to-d365" />
		<flow-ref doc:name="Log Process Exit" doc:id="c330e731-9780-48c2-b596-be1e7effebcc" name="log-process-exit-sub-flow" />
	</sub-flow>
	<sub-flow name="order-extract-send-to-d365" doc:id="4e4ac1cb-968c-45d1-b779-dffb242a456d" >
		<flow-ref doc:name="Log Process Entry" doc:id="50abbf14-8e27-4ba9-b3e0-e776e7c7f8f9" name="log-process-entry-sub-flow" />
				<http:request method="PUT" doc:name="Call D365 HTTP Request Configuration" doc:id="4e264552-d91e-4f1c-8103-e1cc181d1b0d" config-ref="D365_HTTP_Request_configuration" path="${d365.updateOrderExtractPath}" responseTimeout="${response.timeout}">
				<http:body ><![CDATA[#[vars.originalPayload]]]></http:body>
						<http:response-validator>
					<http:success-status-code-validator values="#[200]" />
				</http:response-validator>
		</http:request>
			<flow-ref doc:name="Log Process Exit" doc:id="f51ef891-c345-4662-be6a-f444b1dd34f5" name="log-process-exit-sub-flow" />
	</sub-flow>
</mule>
