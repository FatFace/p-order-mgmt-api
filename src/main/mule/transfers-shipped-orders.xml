<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:sqs="http://www.mulesoft.org/schema/mule/sqs"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/sqs http://www.mulesoft.org/schema/mule/sqs/current/mule-sqs.xsd">
	<sub-flow name="put-transfers-shipped-orders-impl-flow" doc:id="19ec656b-73ea-4641-b1fb-9b67ed624140" >
		<ee:transform doc:name="Set flow name and query parameters" doc:id="d3a93fad-bed1-42ff-b9b7-a722e31c2493" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="flowName" ><![CDATA[%dw 2.0
output application/java
---
'transfers-shipped-orders-trigger-flow']]></ee:set-variable>
				<ee:set-variable variableName="vQueryParams" ><![CDATA[%dw 2.0
output application/java
---
attributes.queryParams]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Log Receiver Entry" doc:id="6f6dde43-815e-402c-a6e8-2e7d2d9ba8d9" name="log-receiver-entry-sub-flow"/>
		<flow-ref doc:name="Audit Receiver Entry" doc:id="3ee341f9-f5f8-4d83-b7fa-3292debf5ee5" name="audit-receiver-entry-sub-flow"/>
		<flow-ref doc:name="call-db-lookup-api-sub-flow" doc:id="804581dc-51fa-49c8-94fd-0e19aae6b99f" name="call-db-lookup-shipped-orders-api-sub-flow"/>		
		<ee:transform doc:name="Filter Lookup Key" doc:id="b3691fdc-8c7b-4157-8454-4b09ca45c98e">
			<ee:message>
			</ee:message>
			<ee:variables >
				<ee:set-variable resource="dwl/filter_lookup_value_transferorder.dwl" variableName="flattenResponse" />
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Transform using Lookup" doc:id="1366b534-7337-4a0c-a633-837b1cefa51b" >
			<ee:message >
				<ee:set-payload resource="dwl/jda-to-d365-tansferorders-mapping.dwl" />
			</ee:message>
		</ee:transform>
		<scatter-gather doc:name="Scatter-Gather" doc:id="0565e0c0-6c69-4de0-a254-a4e3e1c276e3" timeout="1200000">
			<route >
				<ee:transform doc:name="Filter using region as UK and capture region" doc:id="580d4e76-0cf9-4817-b8a9-1942b76dfa38" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
var region = payload filter ($.region == p('region.UK'))
---
{
    "transfer-orders" : region
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="vRegion" ><![CDATA[%dw 2.0
output application/java
---
p('region.UK')]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="call-transfers-shipped-orders-d365-api-sub-flow" doc:id="57cd5de4-4f49-403b-896d-d11c53e30e56" name="call-transfers-shipped-orders-d365-api-sub-flow"/>
			</route>
			<route >
				<ee:transform doc:name="Filter using region as 2FFC and capture region" doc:id="63d97d11-19e9-4ea5-ab39-63819ad43b59" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
var region = payload filter ($.region == p('region.US'))
---
{
    "transfer-orders" : region
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="vRegion" ><![CDATA[%dw 2.0
output application/java
---
p('region.US')]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="call-transfers-shipped-orders-d365-api-sub-flow" doc:id="08ead985-7706-4c5e-83b9-9ca8efb65e94" name="call-transfers-shipped-orders-d365-api-sub-flow"/>
			</route>
		</scatter-gather>
		<ee:transform doc:name="Set Flow Name" doc:id="2fbba602-a747-4fb3-b9aa-f9938f356ed8" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="flowName" ><![CDATA[%dw 2.0
output application/java
---
'call-transfers-shipped-orders-d365-api-sub-flow']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Log Dispatcher Exit" doc:id="d789036d-7d33-4479-8df0-80070584f8a9" name="log-dispatcher-exit-sub-flow"/>
		<flow-ref doc:name="Audit Dispatcher Exit" doc:id="9c78cccd-66e2-4aec-94be-a549f6044f18" name="audit-dispatcher-exit-sub-flow"/>
	</sub-flow>
	<sub-flow name="call-db-lookup-shipped-orders-api-sub-flow" doc:id="ae8be7f7-ac7b-467c-861d-6e11cc02bfe0" >
		<set-variable value="call-db-lookup-api-sub-flow" doc:name="Flow Name" doc:id="cee252be-a6ff-46d2-a6ad-dce347796ee6" variableName="flowName"/>
		<flow-ref doc:name="Log Process Entry" doc:id="e1a22c89-7087-4713-8485-338ee0915ce2" name="log-process-entry-sub-flow"/>
<flow-ref doc:name="Audit Process Entry" doc:id="4a04b761-dab6-423d-bf35-3d4a7eaaf343" name="audit-process-entry-sub-flow"/>
		<http:request method="GET" doc:name="Invoke System Layer Lookup Api to Get Lookup Key" doc:id="15dc0ad8-7ba9-44ca-ab08-c75cd84235b9" path="${lookup.dbLookupPath}" responseTimeout="${response.timeout.system.dblookup.pickOrders}" config-ref="dbLookup_HTTP_Request_configuration" target="lookupResponse">
					<http:headers><![CDATA[#[output application/java
---
{
	"Transaction-Id" : vars.transactionId,
	"client_secret" : p('secure::lookup.clientSecret'),
	"Transaction-Start-Time" : vars.transactionStartTime,
	"client_id" : p('lookup.clientId')
}]]]></http:headers>
					<http:query-params><![CDATA[#[output application/java
---
{
	"source" : p('lookup.queryParam.shippedorderssource'),
	"type" : p('lookup.queryParam.shippedorderstype'),
	"category" : p('lookup.queryParam.shippedorderscatgeory')
}]]]></http:query-params>
				</http:request>
		<flow-ref doc:name="Log Process Exit" doc:id="9934e4ed-b2f9-4515-b7de-b1ce52674899" name="log-process-exit-sub-flow" />
<flow-ref doc:name="Audit Process Exit" doc:id="a4bba50e-f52d-41c2-b64f-df225e3964ee" name="audit-process-exit-sub-flow"/>
	</sub-flow>
	<sub-flow name="call-transfers-shipped-orders-d365-api-sub-flow" doc:id="28bb94a0-e10f-4353-9f3a-3a465fd8c3f7" >
		<set-variable value="call-transfers-shipped-orders-d365-api-sub-flow" doc:name="Flow Name" doc:id="e0c9b232-4191-4a89-a0e6-3032fa49af58" variableName="flowName"/>
		<flow-ref doc:name="Log Process Entry" doc:id="4f557c56-3276-4157-a032-61bf0f4e7f1d" name="log-process-entry-sub-flow"/>
		<flow-ref doc:name="Audit Process Entry" doc:id="6ed567f9-b4a1-4209-b2a7-101f36774409" name="audit-process-entry-sub-flow"/>
		<http:request method="PUT" doc:name="Invoke D365 System Layer" doc:id="2eb85d11-4ccf-41c6-a908-29b11d4668de" config-ref="s_D365_Http_Request_configuration" path="${d365.transferShippedOrders}">
			<http:headers><![CDATA[#[output application/java
---
{
	"Transaction-Id" : vars.transactionId,
	"client_secret" : p('secure::d365.clientSecret'),
	"Transaction-Start-Time" : vars.transactionStartTime,
	"client_id" : p('d365.clientId')
}]]]></http:headers>
			<http:query-params ><![CDATA[#[output application/java
---
{
	"file-name" : vars.vQueryParams."file-name",
	"region" : vars.vRegion
}]]]></http:query-params>
		</http:request>
		<flow-ref doc:name="Log Process Exit" doc:id="8d9125a8-932d-47b5-9d50-1572b5a0fc35" name="log-process-exit-sub-flow"/>
		<flow-ref doc:name="Audit Process Exit" doc:id="2ef7f3e6-ce8f-4b8e-82ea-295ab3feb312" name="audit-process-exit-sub-flow"/>
	</sub-flow>	
</mule>
