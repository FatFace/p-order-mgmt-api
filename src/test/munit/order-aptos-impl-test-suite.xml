<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<munit:config name="order-aptos-impl-test-suite.xml" />
	<import doc:name="Import" doc:id="08a93647-8c9d-4f72-b9a8-e60c3708ca7c" file="common-auditing-framework.xml" />
	<import doc:name="Import" doc:id="0ed3e63f-16d4-488c-b3aa-5d0fa78d87fc" file="common-error-handling.xml" />
	<import doc:name="Import" doc:id="55afe77f-e635-48a2-952e-9b280cac8914" file="common-logging-framework.xml" />
	<import doc:name="Import" doc:id="661b8ddd-f2d7-4a9b-ab7e-35187d393b2b" file="globals.xml" />
	<import doc:name="Import" doc:id="764e4fc6-6e27-427c-89c7-bce7ac59fe17" file="order-managment-app.xml" />
	<import doc:name="Import" doc:id="eed43ac1-b113-4d2f-8f1a-56620d723652" file="order-aptos-impl.xml" />
	<munit:test name="order-aptos-impl-test-suite-create-order-details-from-aptos-to-d365-main-flowTest" description="Test" doc:id="8c77df98-b9bf-44b8-85ba-055b4bdf4cf4" >
		<munit:behavior >
			<munit-tools:mock-when doc:name="Mock Report DB Http Requester" doc:id="02a28410-127a-49ee-b9c8-dfc4db60018b" processor="http:request">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute attributeName="doc:name" whereValue="Call Report DB Http Request Configuration" />
					<munit-tools:with-attribute attributeName="doc:name" whereValue="Call Report DB Http Request Configuration" />
				</munit-tools:with-attributes>
			</munit-tools:mock-when>
			<munit-tools:mock-when doc:name="Mock D365 Http Requester" doc:id="57475b8a-a591-4b83-ad73-657d412dd7d7" processor="http:request">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute attributeName="doc:name" whereValue="Call D365 Http Request Configuration" />
					<munit-tools:with-attribute attributeName="doc:name" whereValue="Call D365 Http Request Configuration" />
				</munit-tools:with-attributes>
			</munit-tools:mock-when>
			<munit-tools:mock-when doc:name="Mock DB DM Lookup Http Requester" doc:id="2cbad921-f942-43cb-9dfe-2197a00a8129" processor="http:request">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute attributeName="doc:name" whereValue="Call DB DM Lookup Http Request Configuration" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:payload value='#[MunitTools::getResourceAsString("sample_data/s-dblookup-delivery-mode-response.json")]' mediaType="application/json" />
				</munit-tools:then-return>
			</munit-tools:mock-when>
			<munit-tools:mock-when doc:name="Mock DB SO Lookup Http Requester" doc:id="eae318b5-11ca-4efe-b22f-e7fef497a46b" processor="http:request">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute attributeName="doc:name" whereValue="Call DB SO Lookup Http Request Configuration" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:payload value='#[MunitTools::getResourceAsString("sample_data/s-dblookup-sales-origin-response.json")]' mediaType="application/json" />
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<set-payload value='#[MunitTools::getResourceAsString("sample_data/s-aptos-get-order-request.json"]' doc:name="Set Payload" doc:id="51dec41f-0d2e-4e04-bfa0-7b20bbe9d0a3" />
			<ee:transform doc:name="Transform Message" doc:id="a0c956f7-fb3a-4e1d-9795-228b12232175" >
				<ee:message >
					<ee:set-attributes ><![CDATA[%dw 2.0
output application/json
---
{
	headers: {
		'Transaction-Id': "2ddbd94c-96c0-4aa2-a0fe-bb7603ebca7c",
		'Transaction-Start-Time': "2018-08-02T16:58:12.121Z",
		'Client-Id': "3ddbd94c96c04aa2a0febb7603e12r4c2",
		'Client-Secret': "3ddbd94c96c04aa2a0febb7603e12r4c2"
	}
}]]></ee:set-attributes>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="reportdbInputPayload" ><![CDATA[%dw 2.0
output application/json
---

{
	"orders": [{
		"order-no": "98759616",
		"order-date": "2019-10-03T18:25:43.200Z",
		"currency": "GBP",
		"language": "en-gb",
		"source": "APTOS",
		"delivery-mode": "standardGBP",
		"legal-entity": "1FFL",
		"store": {
			"store-id": "70257",
			"store-code": "OIS-STD"
		},
		"customer": {
			"customer-id": "9991331068",
			"fullname": "Nicola Carbis",
			"first-name": "Nicola",
			"last-name": "Carbis",
			"telephone": "07905339295",
			"email": "carbis1@btinternet.com",
			"shipping-address": {
				"address-1": "14 Park Close",
				"address-2": "Coveney",
				"address-3": "Cambridgeshire",
				"address-4": "Great Britain",
				"state": "Ely",
				"postcode": "CB6 2DH"
			}
		},
		"orderlines": [{
			"item-id": "1",
			"item-name": "RUBY LEAF SCHIFFLEY LONGLINE WHT-WHITE 6 9EWA",
			"sales-price": 39.5,
			"barcode": "5052751553606",
			"quantity": 1,
			"amount": 39.5,
			"tax-amount": 1.98,
			"tax-rate": 20.0101
		}],
		"payments": [{
			"amount": 39.5,
			"payment-mode": "creditcard",
			"payment-mode-card": {
				"card-number": "******0000000795"
			}
		}],
		'tender': {
        'authorisation': "63456fghjghfg"
      	}
	}]
}]]></ee:set-variable>
					<ee:set-variable variableName="d365InputPayload" ><![CDATA[%dw 2.0
output application/json
---

{
	"orders": [{
		"order-no": "98759616",
		"order-date": "2019-10-03T18:25:43.200Z",
		"currency": "GBP",
		"language": "en-gb",
		"source": "APTOS",
		"delivery-mode": "standardGBP",
		"legal-entity": "1FFL",
		"store": {
			"store-id": "70257",
			"store-code": "OIS-STD"
		},
		"customer": {
			"customer-id": "9991331068",
			"fullname": "Nicola Carbis",
			"first-name": "Nicola",
			"last-name": "Carbis",
			"telephone": "07905339295",
			"email": "carbis1@btinternet.com",
			"shipping-address": {
				"address-1": "14 Park Close",
				"address-2": "Coveney",
				"address-3": "Cambridgeshire",
				"address-4": "Great Britain",
				"state": "Ely",
				"postcode": "CB6 2DH"
			},
			'billing-address': {
		          'street': "hgfgjhkj",
		          'city': "kjhgfhgjh23",
		          'postcode': "jhgfhgjkj1234",
		          'country': "hgfdghghj23243",
		          'state': "TSGHHFGHJK"
        		}
		},
		"orderlines": [{
			"item-id": "1",
			"item-name": "RUBY LEAF SCHIFFLEY LONGLINE WHT-WHITE 6 9EWA",
			"sales-price": 39.5,
			"barcode": "5052751553606",
			"quantity": 1,
			"amount": 39.5,
			"tax-amount": 1.98,
			"tax-rate": 20.0101
		}],
		"payments": [{
			"amount": 39.5,
			"payment-mode": "creditcard",
			"payment-mode-card": {
				"card-number": "******0000000795"
			}
		}],
		'tender': {
        'authorisation': "63456fghjghfg"
      	}
	}]
}]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="Flow-ref to create-order-details-from-aptos-to-d365-main-flow" doc:id="61232f70-d1d7-4a0c-8baa-252057f6b820" name="post:\orders:application\json:p-order-mgmt-api-config" />
		</munit:execution>
		<munit:validation >
			<munit-tools:assert-that doc:name="Assert that" doc:id="a4c72831-335a-4d1e-b29d-2b63e1c2d9c3" is="#[MunitTools::notNullValue()]" expression="#[payload]"/>
		</munit:validation>
	</munit:test>


</mule>
