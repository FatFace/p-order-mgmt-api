<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit" xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd">
	<munit:config name="shipment-manifest-impl-test-suite.xml" />
	<munit:test name="shipment-manifest-impl-test-suite-JDA-shipment-manifest-flowTest" description="Test" doc:id="e8fef8f8-c337-4616-811d-ef0a38ee9e6c">
		<munit:enable-flow-sources>
	<munit:enable-flow-source value="common-template-check-digit-lookup-flow" />
</munit:enable-flow-sources>
		<munit:behavior >
			<munit-tools:mock-when doc:name="S-JDA-HTTP-Request-Configuration" doc:id="89f99ed5-5a3c-4217-9b74-6992f250a46b" processor="http:request">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="S-JDA-HTTP-Request-Configuration" attributeName="doc:name" />
					<munit-tools:with-attribute whereValue="${response.timeout.system.jda.manifest}" attributeName="responseTimeout" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:payload value='#[output application/java --- readUrl("classpath://sample_data/s-jda-manifest-response.json", "application/json")]' />
				</munit-tools:then-return>
			</munit-tools:mock-when>
			<munit-tools:mock-when doc:name="Call D365 HTTP Request Configuration" doc:id="ba39aa86-1241-4747-b18d-e607497e0ad8" processor="http:request">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="Call D365 HTTP Request Configuration" attributeName="doc:name" />
				</munit-tools:with-attributes>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="Set Event" doc:id="49e72fb7-bf0a-4a3e-8809-c8511bb4086c" >
				<munit:attributes value='#[{"headers" :  {"has-more-files":"false","file-name":"testFile"}}]' />
				<munit:variables >
					<munit:variable key="messageCorrelationId" value="testCorrelation" mediaType="application/java" />
					<munit:variable key="transactionStartTime" value="2020-02-17T17:17:05.899Z" mediaType="application/java" />
				</munit:variables>
			</munit:set-event>
			<flow-ref doc:name="Flow-ref to JDA-shipment-manifest-flow" doc:id="39dfa191-a33c-4433-a558-45777b7a65a6" name="JDA-shipment-manifest-flow"/>
		</munit:execution>
	</munit:test>
	<munit:test name="shipment-manifest-impl-test-suite-receive-manifest-message-and-retryTest" description="Test" doc:id="7bde7ca5-9486-4181-a370-e192758a69e3">
		<munit:behavior >
			<munit-tools:mock-when doc:name="Receive Message From Manifest and Retry" doc:id="e76cfe85-b146-4cd5-be1c-43924eb346db" processor="sqs:receivemessages">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="Receive Message From Manifest and Retry" attributeName="doc:name" />
				</munit-tools:with-attributes>
			</munit-tools:mock-when>
			<munit-tools:mock-when doc:name="Delete message" doc:id="b60b2a44-b976-47a4-a9b5-1c1eff535b44" processor="sqs:delete-message">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="Delete message" attributeName="doc:name" />
				</munit-tools:with-attributes>
			</munit-tools:mock-when>
			<munit-tools:mock-when doc:name="Call D365 HTTP Request Configuration" doc:id="cefa1790-f523-4a40-939a-19761174fcf8" processor="http:request">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="Call D365 HTTP Request Configuration" attributeName="doc:name" />
				</munit-tools:with-attributes>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="Set Event" doc:id="bbe97646-21b1-4054-ba78-863f5aa6da15" >
				<munit:payload value="#[MunitTools::getResourceAsString('sample_data/receive-message-manifest-payload.json')]" />
				<munit:attributes value='#[{
	"correlationId": {
		"stringValue": "testString"
	},
	"transactionStartTime": {
		"stringValue": "2020-02-18T06:05:16.363Z"
	},
	"transactionId": {
		"stringValue": "testID"
	},
	"reprocessingCount": {
		"stringValue": "1"
	},
	"transactionFileName": {
		"stringValue": "testFile"
	},
	"sqs": {
		"message": {
			"receipt": {
				"handle": "testReceipt"
			}
		}
	}
}]' />
			</munit:set-event>
			<flow-ref doc:name="Flow-ref to receive-manifest-message-and-retry" doc:id="9967dc9f-0a5d-4e7a-90d0-ff877cf246a9" name="receive-manifest-message-and-retry"/>
		</munit:execution>
	</munit:test>


</mule>
